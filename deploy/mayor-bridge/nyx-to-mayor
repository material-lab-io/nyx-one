#!/bin/bash
# nyx-to-mayor â€” Send a message from Nyx to Mayor
# In container: uses mayor-bridge HTTP adapter (MAYOR_BRIDGE_URL set)
# On host:      calls gt mail send directly

set -euo pipefail

SUBJECT="${1:?Usage: nyx-to-mayor \"subject\" \"body\"}"
BODY="${2:?Usage: nyx-to-mayor \"subject\" \"body\"}"
FROM="${BRIDGE_FROM:-nyx}"

if [ -n "${MAYOR_BRIDGE_URL:-}" ]; then
  # Container mode: POST to mayor-bridge via node (no curl/wget in image)
  FROM="$FROM" SUBJECT="$SUBJECT" BODY="$BODY" \
  MAYOR_BRIDGE_TOKEN="${MAYOR_BRIDGE_TOKEN:?MAYOR_BRIDGE_TOKEN not set}" \
  node -e "
const http = require('${MAYOR_BRIDGE_URL}'.startsWith('https') ? 'https' : 'http');
const url = new URL('${MAYOR_BRIDGE_URL}/mail'.replace(/'/g, ''));
const payload = JSON.stringify({ from: process.env.FROM, subject: process.env.SUBJECT, body: process.env.BODY });
const opts = {
  hostname: url.hostname,
  port: url.port || (url.protocol === 'https:' ? 443 : 80),
  path: url.pathname,
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + process.env.MAYOR_BRIDGE_TOKEN,
    'Content-Length': Buffer.byteLength(payload)
  }
};
const req = http.request(opts, res => {
  let data = '';
  res.on('data', d => data += d);
  res.on('end', () => {
    if (res.statusCode >= 200 && res.statusCode < 300) {
      process.stdout.write('ok\n');
    } else {
      process.stderr.write('bridge error ' + res.statusCode + ': ' + data + '\n');
      process.exit(1);
    }
  });
});
req.on('error', e => { process.stderr.write('request failed: ' + e.message + '\n'); process.exit(1); });
req.write(payload);
req.end();
"
else
  # Host mode: call gt mail directly
  cd /home/kanaba/gt
  exec gt mail send mayor/ -s "${FROM}:${SUBJECT}" --stdin <<BODY_END
${BODY}
BODY_END
fi
